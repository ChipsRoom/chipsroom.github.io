<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* (All existing CSS styles here) */
    </style>
</head>

<body>
    <div id="sidebar">
        <h3>Online Users:</h3>
        <div id="online-list">Fetching...</div>
        <button id="clear-messages-btn">Clear Messages</button>
    </div>
    <div id="chat-container">
        <!-- Login Section -->
        <div id="login-section">
            <h2 style="color: white;">Enter Your Username</h2>
            <input type="text" id="username-input" placeholder="Enter your username" required>
            <button id="set-username-btn">Join Chat</button>
        </div>

        <!-- Chat Section -->
        <div id="chat-section" style="display: none;">
            <div id="chat-display"></div>
            <div id="message-container">
                <input type="text" id="message-input" placeholder="Type your message..." required>
                <button id="send-message-btn">Send</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            /* (Firebase config here) */
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const usernameInput = document.getElementById('username-input');
        const setUsernameBtn = document.getElementById('set-username-btn');
        const chatSection = document.getElementById('chat-section');
        const chatDisplay = document.getElementById('chat-display');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const onlineList = document.getElementById('online-list');
        const clearMessagesBtn = document.getElementById('clear-messages-btn');
        const sidebar = document.getElementById('sidebar');

        let username = '';
        let userRefKey = '';
        let isMod = false;
        const USERNAME_LIMIT = 20;
        const MESSAGE_LIMIT = 200;

        // Join chat
        setUsernameBtn.addEventListener('click', () => {
            username = usernameInput.value.trim();
            if (username && username.length <= USERNAME_LIMIT) {
                saveUsername(username);
                chatSection.style.display = 'flex';
                document.getElementById('login-section').style.display = 'none';
                sidebar.style.display = 'flex';
            } else {
                alert(`Username must be less than or equal to ${USERNAME_LIMIT} characters.`);
            }
        });

        // Send message
        sendMessageBtn.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message && message.length <= MESSAGE_LIMIT) {
                const chatItemRef = database.ref('chat').push();
                chatItemRef.set({
                    username: isMod ? 'MOD ' + username : username,
                    message: message,
                    timestamp: new Date().toISOString()
                });
                messageInput.value = '';
                chatDisplay.scrollTop = chatDisplay.scrollHeight;
            } else {
                alert(`Message must be less than or equal to ${MESSAGE_LIMIT} characters.`);
            }
        });

        // Load chat messages
        function loadChat() {
            database.ref('chat').on('value', (snapshot) => {
                const chats = snapshot.val();
                chatDisplay.innerHTML = '';
                for (let key in chats) {
                    const chatItem = chats[key];
                    const chatElement = document.createElement('div');
                    chatElement.classList.add('chat-item');
                    chatElement.innerHTML = `<strong>${chatItem.username}</strong>: ${chatItem.message}`;
                    chatDisplay.appendChild(chatElement);
                }
                chatDisplay.scrollTop = chatDisplay.scrollHeight;
            });
        }

        // Save username and update online users
        function saveUsername(username) {
            userRefKey = database.ref('users').push().key;
            database.ref('users/' + userRefKey).set({
                username: username,
            });
            database.ref('users/' + userRefKey).onDisconnect().remove();
            loadOnlineUsers();
            loadChat();
        }

        // Load online users
        function loadOnlineUsers() {
            database.ref('users').on('value', (snapshot) => {
                const users = snapshot.val();
                onlineList.innerHTML = '';
                for (let key in users) {
                    const user = users[key];
                    const userElement = document.createElement('div');
                    userElement.classList.add('user');
                    userElement.textContent = user.username;
                    userElement.setAttribute('data-user-key', key);

                    // If mod, add control buttons
                    if (isMod) {
                        const kickBtn = document.createElement('button');
                        kickBtn.textContent = 'Kick';
                        kickBtn.onclick = () => kickUser(key);
                        userElement.appendChild(kickBtn);
                    }

                    onlineList.appendChild(userElement);
                }
            });
        }

        // Keyboard shortcut to become mod (Shift + Alt + 7)
        document.addEventListener('keydown', (event) => {
            if (event.shiftKey && event.altKey && event.code === 'Digit7') {
                toggleMod();
            }
        });

        // Toggle mod status
        function toggleMod() {
            isMod = !isMod;
            alert(isMod ? 'You are now a mod.' : 'Mod privileges removed.');
            loadOnlineUsers();
        }

        // Kick user function
        function kickUser(userKey) {
            database.ref('users/' + userKey).remove();
        }

        // Initialize
        loadChat();
    </script>
</body>

</html>
